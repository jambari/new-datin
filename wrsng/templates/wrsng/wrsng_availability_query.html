{% extends "base.html" %}

{% block content %}
<style>
    /* Styling Filter & Tombol */
    .custom-filter-box {
        background-color: #ffffff;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .custom-select {
        padding: 5px 10px;
        border: 1px solid #999;
        border-radius: 4px;
        font-size: 13px;
        min-width: 100px;
        cursor: pointer;
    }
    .custom-btn {
        background-color: #4f46e5;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: bold;
        cursor: pointer;
    }
    .custom-btn-green {
        background-color: #10b981;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: bold;
        cursor: pointer;
    }

    /* Styling Tabel Matrix */
    .matrix-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        font-size: 11px;
    }
    .matrix-table th, .matrix-table td {
        text-align: center;
        border: 1px solid #ccc;
        padding: 0; 
        height: 25px;
    }
    .col-day { width: 25px; min-width: 25px; }
    
    /* Input Editable */
    .matrix-input {
        width: 100%;
        height: 100%;
        text-align: center;
        border: none;
        background: transparent;
        font-weight: 600;
        color: #1f2937;
        font-size: 11px;
        padding: 5px 0;
    }
    .matrix-input:focus {
        outline: 2px solid #3b82f6;
        background-color: white;
        z-index: 10;
        position: relative;
    }
    /* Hide number spinner */
    .matrix-input::-webkit-outer-spin-button,
    .matrix-input::-webkit-inner-spin-button {
        -webkit-appearance: none; margin: 0;
    }

    /* Sticky Columns */
    .sticky-col { position: sticky; left: 0; z-index: 20; border-right: 2px solid #9ca3af; }
    thead th.sticky-col { background-color: #1f2937; color: white; z-index: 30; }
    tbody td.sticky-col { background-color: #f9fafb; color: #111827; z-index: 20; }
</style>

<div class="flex h-screen bg-gray-100">
  {% include 'partials/_sidebar.html' %}
  
  <div class="flex-1 flex flex-col overflow-hidden">
    {% include 'partials/_topbar.html' %} 

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4">
        <div class="container mx-auto">
            
            <!-- HEADER -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-gray-800">{{ page_title }}</h1>
                
                <form method="get" class="custom-filter-box">
                    <div>
                        <span class="text-xs font-bold text-gray-600">Bulan:</span>
                        <select name="month" class="custom-select">
                            {% for m in months_range %}
                            <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-gray-600">Tahun:</span>
                        <select name="year" class="custom-select">
                            {% for y in years_range %}
                            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="custom-btn">Tampilkan</button>
                </form>
            </div>

            <!-- TABEL -->
            <div class="bg-white shadow rounded-lg overflow-hidden mb-4">
                <div class="overflow-x-auto">
                    <table class="matrix-table">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="sticky-col py-1" style="width: 30px;">No</th>
                                <th class="sticky-col py-1" style="left: 30px; width: 150px;">Lokasi WRSNG</th>
                                {% for d in list_tanggal %}
                                    <th class="col-day">{{ d }}</th>
                                {% endfor %}
                                <th class="bg-gray-700" style="width: 50px;">Avg</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                            {% for row in tabel_data %}
                            <tr>
                                <td class="sticky-col font-mono">{{ forloop.counter }}</td>
                                <td class="sticky-col font-bold" style="left: 30px; text-align: left; padding-left: 8px;">{{ row.nama }}</td>
                                
                                {% for day in row.hari %}
                                <td>
                                    <input type="number" 
                                           class="matrix-input"
                                           value="{{ day.val|floatformat:0 }}"
                                           data-station="{{ row.nama }}"
                                           data-date="{{ day.full_date }}"
                                           min="0" max="100"
                                           onchange="handleEdit(this)">
                                </td>
                                {% endfor %}

                                <td class="font-bold bg-gray-100" id="avg-{{ row.nama }}">{{ row.avg_row|floatformat:0 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- CHART -->
            <div class="bg-white shadow rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">SLA {{ sensor_name }} Bulan {{ month_name }} {{ selected_year }}</h3>
                    <button type="button" onclick="forceUpdateChart()" class="custom-btn-green">Refresh Chart</button>
                </div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="availabilityChart"></canvas>
                </div>
            </div>

        </div>
    </main>
  </div>
</div>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    const updateApiUrl = "{{ update_url }}";
    const currentSensorType = "{{ sensor_type }}";
    let myChart = null;

    // Helper Warna
    function getChartColor(val) {
        if (val > 80) return '#4ade80';
        if (val >= 50) return '#facc15';
        if (val >= 25) return '#fb923c';
        return '#f87171';
    }

    function setCellColor(input) {
        const val = parseFloat(input.value);
        const td = input.parentElement;
        td.style.backgroundColor = '';
        td.style.color = 'black';

        if (val > 80) td.style.backgroundColor = '#4ade80';
        else if (val >= 50) td.style.backgroundColor = '#facc15';
        else if (val >= 25) td.style.backgroundColor = '#fb923c';
        else {
            td.style.backgroundColor = '#f87171';
            td.style.color = 'white';
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.matrix-input').forEach(input => setCellColor(input));
        renderChart();
        
        // Init Toggle Sidebar Mobile (if needed, though base.html usually handles it)
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('hidden');
            });
        }
    });

    function handleEdit(input) {
        const station = input.dataset.station;
        const date = input.dataset.date;
        let value = parseFloat(input.value);

        if (isNaN(value)) value = 0;
        if (value > 100) value = 100;
        if (value < 0) value = 0;
        input.value = value;

        setCellColor(input);
        recalculateRowAvg(station); // Update chart immediately

        fetch(updateApiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({ station, date, value, sensor_type: currentSensorType })
        }).then(res => res.json()).catch(err => console.error("Update error:", err));
    }

    function recalculateRowAvg(stationName) {
        // Safe selector for stations with spaces
        const inputs = document.querySelectorAll(`input[data-station="${stationName}"]`);
        let total = 0;
        let count = 0;
        inputs.forEach(inp => { total += parseFloat(inp.value || 0); count++; });
        
        if (count > 0) {
            const avg = parseFloat((total / count).toFixed(2));
            const avgCell = document.getElementById(`avg-${stationName}`);
            if(avgCell) avgCell.innerText = avg.toFixed(0);
            updateSingleChartData(stationName, avg);
        }
    }

    function updateSingleChartData(stationName, newAvg) {
        if (!myChart) return;
        const index = myChart.data.labels.indexOf(stationName);
        if (index !== -1) {
            myChart.data.datasets[0].data[index] = newAvg;
            myChart.data.datasets[0].backgroundColor[index] = getChartColor(newAvg);
            myChart.update('none'); // Update without animation for responsiveness
        } else {
            console.warn("Station not found in chart:", stationName);
        }
    }

    function forceUpdateChart() {
        if (!myChart) return;
        const labels = myChart.data.labels;
        const newData = [];
        const newColors = [];
        
        labels.forEach((stationName) => {
            const avgCell = document.getElementById(`avg-${stationName}`);
            let val = avgCell ? (parseFloat(avgCell.innerText) || 0) : 0;
            newData.push(val);
            newColors.push(getChartColor(val));
        });
        
        myChart.data.datasets[0].data = newData;
        myChart.data.datasets[0].backgroundColor = newColors;
        myChart.update();
    }

    function renderChart() {
        const ctx = document.getElementById('availabilityChart').getContext('2d');
        Chart.register(ChartDataLabels);

        // Use escapejs to ensure strings are safe for JS
        const labels = [ {% for row in tabel_data %} "{{ row.nama|escapejs }}", {% endfor %} ];
        const dataValues = [ {% for row in tabel_data %} {{ row.avg_row }}, {% endfor %} ];
        const backgroundColors = dataValues.map(val => getChartColor(val));

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Rata-rata Availability (%)',
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 30 } },
                scales: {
                    y: { beginAtZero: true, max: 100 },
                    x: { ticks: { autoSkip: false } }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'end', offset: -4,
                        formatter: (val) => (val > 0 ? Math.round(val) : "")
                    }
                }
            }
        });
    }
</script>
{% endblock %}