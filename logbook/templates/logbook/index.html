{% extends "base.html" %}
{% load static %}
{% load tz %}

{% block content %}
<div class="flex h-screen bg-gray-100">
  
  <style>
      .compact-container { max-width: 1000px; margin: 0 auto; width: 95%; }

      /* Tombol Submit Form */
      .btn-custom-submit {
          background-color: #198754 !important; color: white !important;
          padding: 10px 20px; border-radius: 6px; font-weight: bold;
          border: none; cursor: pointer; width: 100%; transition: 0.2s;
      }
      .btn-custom-submit:hover { background-color: #157347 !important; }

      /* Tombol Print */
      .btn-custom-print {
          background-color: #0d6efd !important; color: white !important;
          padding: 6px 12px; border-radius: 20px; font-size: 12px;
          text-decoration: none; display: inline-flex; align-items: center;
      }
      .btn-custom-print:hover { background-color: #0b5ed7 !important; }

      .btn-custom-edit {
          background-color: #f59e0b !important; /* Warna Amber */
          color: white !important;
          padding: 6px 12px; border-radius: 20px; font-size: 11px;
          text-decoration: none; display: inline-flex; align-items: center;
          font-weight: 600;
          margin-right: 5px; /* Jarak dengan tombol print */
      }

      /* Tombol Filter & Pagination */
      .btn-outline {
          border: 1px solid #d1d5db; background-color: white; color: #374151;
          padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;
      }
      .btn-outline:hover { background-color: #f3f4f6; }
      
      .btn-primary-sm {
          background-color: #2563eb; color: white; border: none;
          padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;
      }
      .btn-primary-sm:hover { background-color: #1d4ed8; }

      /* Styling Form & Table */
      .form-group { margin-bottom: 12px; }
      .form-label { font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 4px; display: block; }
      .form-control { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; }

      .custom-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
      .custom-table th { background-color: #f3f4f6; text-align: left; padding: 10px; border-bottom: 2px solid #e5e7eb; color: #4b5563; font-weight: 600; }
      .custom-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
      .custom-table tr:hover { background-color: #f9fafb; }

      @media print {
          body * { visibility: hidden; }
          .no-print { display: none !important; }
      }
  </style>

  {% include 'partials/_sidebar.html' %}

  <div class="flex-1 flex flex-col overflow-hidden">
    
    {% include 'partials/_topbar.html' %} 

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4">
        
        <div class="compact-container">

            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Logbook Harian</h1>
                <div class="text-xs text-gray-500">IP: <span class="font-mono">{{ user_ip }}</span></div>
            </div>

            {% if messages %}
                {% for message in messages %}
                    <div class="p-3 mb-4 text-sm rounded border {% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% else %}bg-green-100 border-green-400 text-green-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <div class="grid grid-cols-1 gap-6">
                
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Input Log Baru</h2>
                    
                    {% if is_authorized %}
                        <form method="POST">
                            {% csrf_token %}
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 form-group">
                                <div><label class="form-label">{{ form.shift.label }}</label>{{ form.shift }}</div>
                                <div><label class="form-label">{{ form.status_absen.label }}</label>{{ form.status_absen }}</div>
                            </div>

                            <div class="form-group" id="div_petugas_sebelum">
                                <label class="form-label">{{ form.petugas_sebelum.label }}</label>{{ form.petugas_sebelum }}
                            </div>
                            <div class="form-group hidden" id="div_petugas_selanjutnya">
                                <label class="form-label">{{ form.petugas_selanjutnya.label }}</label>{{ form.petugas_selanjutnya }}
                            </div>

                            <hr class="my-3 border-gray-100">

                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 form-group">
                                {% for field in form %}
                                    {% if field.name not in 'shift status_absen petugas_sebelum petugas_selanjutnya catatan' %}
                                    <div><label class="form-label text-xs">{{ field.label }}</label>{{ field }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="form-group">
                                <label class="form-label">{{ form.catatan.label }}</label>{{ form.catatan }}
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn-custom-submit">Simpan Log</button>
                            </div>
                        </form>
                    {% else %}
                        <div class="bg-red-50 border-l-4 border-red-500 p-4">
                            <p class="text-sm text-red-700">Akses Ditolak.</p>
                        </div>
                    {% endif %}
                </div>

                <div class="bg-white shadow rounded-lg overflow-hidden border border-gray-200">
                    
                    <div class="p-4 bg-gray-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                        <h3 class="font-bold text-gray-700">{{ filter_info }}</h3>
                        
                        <form method="GET" class="flex items-center gap-2">
                            <div class="flex items-center gap-2">
                                <input type="date" name="start_date" value="{{ start_date }}" class="border rounded px-2 py-1 text-sm text-gray-700" required>
                                <span class="text-gray-400">-</span>
                                <input type="date" name="end_date" value="{{ end_date }}" class="border rounded px-2 py-1 text-sm text-gray-700" required>
                            </div>
                            <button type="submit" class="btn-primary-sm">Cari</button>
                            <a href="{% url 'logbook:logbook_list' %}" class="btn-outline text-xs">Reset</a>
                        </form>
                    </div>
                    
                    <div class="overflow-x-auto">
                        {% if page_obj %}
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th width="20%">Jam (WIT)</th>
                                    <th width="20%">Shift</th>
                                    <th width="40%">Info Handover / Petugas</th>
                                    <th width="20%" class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in page_obj %}
                                <tr>
                                    <td>
                                        <div class="font-bold text-gray-900">{{ log.waktu_dibuat|timezone:"Asia/Jayapura"|date:"H:i" }}</div>
                                        <div class="text-xs text-gray-500">{{ log.tanggal|date:"d M Y" }}</div>
                                    </td>
                                    <td><span class="block text-gray-800">{{ log.shift }}</span></td>
                                    <td>
                                        <div class="text-sm font-semibold">{{ log.petugas.username|title }}</div>
                                        <div class="text-xs mt-1">
                                            {% if log.status_absen == 'Masuk' %}
                                                <span class="text-blue-600 font-bold">MASUK</span> 
                                                <span class="text-gray-500">(Ganti: {{ log.petugas_sebelum.username|default:"-"|title }})</span>
                                            {% else %}
                                                <span class="text-red-600 font-bold">PULANG</span>
                                                <span class="text-gray-500">(Diganti: {{ log.petugas_selanjutnya.username|default:"-"|title }})</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="flex justify-center items-center">
                                            
                                            <a href="{% url 'logbook:edit_log' log.id %}" class="btn-custom-edit">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                                Edit
                                            </a>

                                            <a href="{% url 'logbook:print_log_detail' log.id %}" target="_blank" class="btn-custom-print">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                                Print
                                            </a>

                                        </div>
                                    </td>
                                                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                            <span class="text-sm text-gray-600">
                                Hal {{ page_obj.number }} dari {{ page_obj.paginator.num_pages }}
                            </span>
                            
                            <div class="flex gap-2">
                                {% if page_obj.has_previous %}
                                    <a href="?page={{ page_obj.previous_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}" class="btn-outline">
                                        &laquo; Prev
                                    </a>
                                {% endif %}

                                {% if page_obj.has_next %}
                                    <a href="?page={{ page_obj.next_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}" class="btn-outline">
                                        Next &raquo;
                                    </a>
                                {% endif %}
                            </div>
                        </div>

                        {% else %}
                        <div class="p-6 text-center">
                            <p class="text-gray-500 italic">Tidak ada log ditemukan untuk periode ini.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
    </main>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusField = document.getElementById('id_status_absen');
        const divSebelum = document.getElementById('div_petugas_sebelum');
        const divSelanjutnya = document.getElementById('div_petugas_selanjutnya');

        if(statusField && divSebelum && divSelanjutnya){
            function toggleFields() {
                if (statusField.value === 'Masuk') {
                    divSebelum.classList.remove('hidden');
                    divSelanjutnya.classList.add('hidden');
                    const selectSelanjutnya = divSelanjutnya.querySelector('select');
                    if(selectSelanjutnya) selectSelanjutnya.value = ""; 
                } else {
                    divSebelum.classList.add('hidden');
                    divSelanjutnya.classList.remove('hidden');
                    const selectSebelum = divSebelum.querySelector('select');
                    if(selectSebelum) selectSebelum.value = "";
                }
            }
            toggleFields();
            statusField.addEventListener('change', toggleFields);
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');

    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', function() {
        // This toggles the 'hidden' class on the sidebar for mobile
        sidebar.classList.toggle('hidden');
      });
    }
  });
</script>
{% endblock %}